<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PWA é©—å±‹ App</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #f4f6f8; padding-bottom: 5rem; }
    .grid-icon { font-size: 2rem; color: #005a8d; }
    .grid-label { font-size: 0.95rem; margin-top: 0.5rem; color: #333; }
    .toolbar { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
    #annotationCanvas { border:1px solid #ccc; touch-action: none; cursor: default; }
    .tab-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; box-shadow: 0 -1px 5px rgba(0,0,0,0.1); z-index: 1000; }
    .tab-bar .nav-link { color: #777; }
    .tab-bar .nav-link.active { color: #005a8d; }
    .d-none { display: none; }
/* å®¹å™¨å¯¬åº¦é™å®šç‚ºè¢å¹•å¯¬åº¦ï¼Œä¸æœƒè¶…å‡º */
#canvasContainer {
  width: 100%;
  max-width: 100%;
  overflow-x: auto; /* å¯¬åœ–å¯å·¦å³æ»‘å‹• */
}

/* ç•«å¸ƒå¯¬åº¦ä»¥å®¹å™¨ 100% ç‚ºä¸»ï¼Œé«˜åº¦è‡ªå‹• */
#annotationCanvas {
  display: block;
  width: 100%;
  height: auto;
  border: 1px solid #ccc;
  touch-action: none;
  cursor: crosshair;
}

  </style>
</head>
<body>

  <!-- é¦–é  -->
  <div class="container py-4" id="homePage">
    <h5 class="text-center mb-4">æ›´å¤šåŠŸèƒ½</h5>
    <div class="row text-center g-4">
      <div class="col-4"><i class="bi bi-person-plus grid-icon"></i><div class="grid-label">åŠ å…¥å¸³è™Ÿ</div></div>
      <div class="col-4"><i class="bi bi-person-lines-fill grid-icon"></i><div class="grid-label">å€‹äººè³‡æ–™</div></div>
      <div class="col-4"><i class="bi bi-flag grid-icon"></i><div class="grid-label">ä¼æ¥­é©—å±‹</div></div>
      <div class="col-4"><i class="bi bi-gear grid-icon"></i><div class="grid-label">è¨­å®š</div></div>
      <div class="col-4"><i class="bi bi-clock grid-icon"></i><div class="grid-label">é ç´„è¨˜éŒ„</div></div>
      <div class="col-4"><i class="bi bi-file-earmark-pdf grid-icon"></i><div class="grid-label">åŒ¯å‡ºå ±å‘Š</div></div>
      <div class="col-4"><i class="bi bi-images grid-icon"></i><div class="grid-label">ç›¸ç°¿ç®¡ç†</div></div>
      <div class="col-4" onclick="showInspectionForm()" style="cursor:pointer;"><i class="bi bi-pencil-square grid-icon"></i><div class="grid-label">é–‹å§‹é©—å±‹</div></div>
      <div class="col-4"><i class="bi bi-shield-check grid-icon"></i><div class="grid-label">å®‰å…¨ç°½ç½²</div></div>
    </div>
  </div>

  <!-- é–‹å§‹é©—å±‹é é¢ -->
  <div class="container py-4 d-none" id="inspectionPage">
    <h5 class="text-center mb-4">é–‹å§‹é©—å±‹</h5>
    <form id="startInspectionForm">
      <div class="mb-3">
        <label class="form-label">é¸æ“‡æ£Ÿåˆ¥</label>
        <select class="form-select" id="buildingSelect" onchange="loadUnits()">
          <option>è«‹é¸æ“‡</option>
          <option>Aæ£Ÿ</option>
          <option>Bæ£Ÿ</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">é¸æ“‡æˆ¶åˆ¥</label>
        <select class="form-select" id="unitSelect" onchange="loadOwnerInfo()">
          <option>è«‹å…ˆé¸æ“‡æ£Ÿåˆ¥</option>
        </select>
      </div>
      <div class="mb-3"><label class="form-label">é–€ç‰Œ</label><input type="text" class="form-control" id="address" readonly></div>
      <div class="mb-3"><label class="form-label">å±‹ä¸»å§“å</label><input type="text" class="form-control" id="owner" readonly></div>
      <div class="mb-3"><label class="form-label">é›»è©±</label><input type="text" class="form-control" id="phone" readonly></div>
      <div class="mb-3"><label class="form-label">è»Šä½</label><input type="text" class="form-control" id="parking" readonly></div>
      <div class="mb-3"><label class="form-label">å‚™è¨»</label><textarea class="form-control" id="remarks" rows="2" readonly></textarea></div>
      <div class="mb-3"><label class="form-label">é©—å±‹æ™‚é–“</label><input type="datetime-local" class="form-control" id="inspectionTime"></div>
      <div class="mb-3"><label class="form-label">é©—å±‹äººå“¡</label><input type="text" class="form-control" id="inspector" value="ç›®å‰ç™»å…¥å¸³è™Ÿ" readonly></div>
      <button type="button" class="btn btn-primary w-100" onclick="enterInspectionFlow()">é–‹å§‹é©—å±‹æµç¨‹</button>
      <button type="button" class="btn btn-secondary mt-2 w-100" onclick="goBack()">è¿”å›é¦–é </button>
    </form>
  </div>

  <!-- é©—å±‹æµç¨‹é é¢ -->
  <div class="container py-4 d-none" id="inspectionFlowPage">
    <h5 class="text-center mb-4">é©—å±‹æµç¨‹</h5>
    <form id="inspectionFlowForm" onsubmit="saveItem(event)">

      <div class="mb-3">
        <label class="form-label">é¸æ“‡å€åŸŸ</label>
        <select class="form-select" id="areaSelect" onchange="loadInspectionItems()">
          <option>å®¢å»³</option><option>å»šæˆ¿</option><option>ä¸»è‡¥</option><option>æ¬¡è‡¥A</option>
          <option>æ¬¡è‡¥B</option><option>æ¬¡è‡¥C</option><option>ä¸»æµ´</option><option>æ¬¡æµ´</option>
          <option>å‰é™½å°</option><option>å¾Œé™½å°</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">æª¢æŸ¥é …ç›®</label>
        <select class="form-select" id="itemSelect">
          <option>åœ°æ¿å¹³æ•´</option><option>ç‰†é¢è£‚ç¸«</option><option>çª—æˆ¶å¯†åˆ</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">ç‹€æ³</label>
        <select class="form-select" id="statusSelect">
          <option>æ­£å¸¸</option><option>ç•°å¸¸</option><option>å¾…ç¢ºèª</option><option>æœªæ–½æ¸¬</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">ä¸Šå‚³ç…§ç‰‡ä¸¦æ¨™è¨»</label>
        <input type="file" class="form-control" accept="image/*" onchange="previewAndAnnotate(event)">
        <div id="toolbar" class="toolbar d-none mt-3">
          <input type="color" id="colorPicker" value="#ff0000">
          <input type="range" id="brushSize" min="1" max="20" value="3">
          <button type="button" onclick="setTool('brush')" class="btn btn-sm btn-outline-secondary">ç•«ç­†</button>
          <button type="button" onclick="setTool('rect')" class="btn btn-sm btn-outline-secondary">çŸ©å½¢</button>
          <button type="button" onclick="setTool('ellipse')" class="btn btn-sm btn-outline-secondary">æ©¢åœ“</button>
          <button type="button" onclick="clearAnnotations()" class="btn btn-sm btn-outline-secondary">æ¸…é™¤æ‰€æœ‰è¨»è¨˜</button>
        </div>
        <div id="canvasContainer" class="d-none mt-2"><canvas id="annotationCanvas"></canvas></div>
      </div>

      <div class="mb-3"><label class="form-label">èªªæ˜</label><textarea class="form-control" id="description" rows="3"></textarea></div>
      <button type="submit" class="btn btn-success w-100">ä¿å­˜ä¸¦ç¹¼çºŒ</button>
      <button type="button" class="btn btn-secondary mt-2 w-100" onclick="goBackToStart()">è¿”å›æˆ¶åˆ¥é¸æ“‡</button>
    </form>
  </div>

  <!-- åº•éƒ¨å°èˆª -->
  <nav class="tab-bar nav nav-pills nav-justified">
    <a class="nav-link active" href="#"><i class="bi bi-person"></i><br>äººå“¡</a>
    <a class="nav-link" href="#"><i class="bi bi-house"></i><br>è¨˜éŒ„</a>
    <a class="nav-link" href="#"><i class="bi bi-plus-circle"></i><br>æ–°å¢</a>
    <a class="nav-link" href="#"><i class="bi bi-image"></i><br>ç…§ç‰‡</a>
    <a class="nav-link" href="#"><i class="bi bi-three-dots"></i><br>æ›´å¤š</a>
  </nav>

  <script>
    let ctx, initialImageData, origImageData, drawing=false, startX, startY, tool='brush';

function showInspectionForm() {
  document.getElementById('homePage').classList.add('d-none');
  document.getElementById('inspectionPage').classList.remove('d-none');

  // å°‡ UTC æ™‚é–“è½‰ç‚ºå°ç£æ™‚é–“ï¼ˆUTC+8ï¼‰
  const now = new Date();
  const tzOffset = now.getTimezoneOffset() * 60000; // æ™‚å€åç§»æ¯«ç§’æ•¸
  const taiwanTime = new Date(now.getTime() - tzOffset + (0 * 3600000)); // UTC + 8
  const formatted = taiwanTime.toISOString().slice(0, 16);
  document.getElementById('inspectionTime').value = formatted;
}




    function goBack() {
      document.getElementById('inspectionPage').classList.add('d-none');
      document.getElementById('homePage').classList.remove('d-none');
    }

    function enterInspectionFlow() {
      document.getElementById('inspectionPage').classList.add('d-none');
      document.getElementById('inspectionFlowPage').classList.remove('d-none');
    }

    function goBackToStart() {
      document.getElementById('inspectionFlowPage').classList.add('d-none');
      document.getElementById('inspectionPage').classList.remove('d-none');
    }

    function loadUnits() {
      const b = document.getElementById('buildingSelect').value;
      const u = document.getElementById('unitSelect'); u.innerHTML = '';
      if (b==='Aæ£Ÿ') u.innerHTML = '<option>1F-1</option><option>2F-1</option>';
      else if (b==='Bæ£Ÿ') u.innerHTML = '<option>1F-2</option><option>2F-2</option>';
      else u.innerHTML = '<option>è«‹å…ˆé¸æ“‡æ£Ÿåˆ¥</option>';
    }

    function loadOwnerInfo() {
      const unit = document.getElementById('unitSelect').value;
      document.getElementById('address').value = unit + ' è™Ÿ';
      document.getElementById('owner').value = 'å¼µä¸‰';
      document.getElementById('phone').value = '0912345678';
      document.getElementById('parking').value = 'B1-23';
      document.getElementById('remarks').value = 'é«˜æ¨“å±¤æ™¯è§€æˆ¶';
    }

    function loadInspectionItems() {
      const area = document.getElementById('areaSelect').value;
      const sel = document.getElementById('itemSelect'); sel.innerHTML = '';
      if (area==='å»šæˆ¿') sel.innerHTML = '<option>ç“¦æ–¯ç®¡ç·š</option><option>æ’æ²¹ç…™æ©Ÿ</option><option>æµç†è‡º</option>';
      else if (area==='ä¸»æµ´') sel.innerHTML = '<option>é¦¬æ¡¶</option><option>æ°´é¾é ­</option><option>æ’æ°´å­”</option>';
      else sel.innerHTML = '<option>åœ°æ¿å¹³æ•´</option><option>ç‰†é¢è£‚ç¸«</option><option>æ’åº§</option>';
    }

    function setTool(t) {
      tool = t;
      const c = document.getElementById('annotationCanvas');
      if (c) c.style.cursor = 'crosshair';
    }

    function previewAndAnnotate(e) {
      const file = e.target.files[0]; if (!file) return;
      const img = new Image();
      img.onload = function() {
        const canvas = document.getElementById('annotationCanvas');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        initialImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        origImageData = initialImageData;
        document.getElementById('toolbar').classList.remove('d-none');
        document.getElementById('canvasContainer').classList.remove('d-none');
        setTool(tool);
        canvas.onpointerdown = pointerDown;
        canvas.onpointermove = pointerMove;
        canvas.onpointerup = pointerUp;
      };
      img.src = URL.createObjectURL(file);
    }

    function pointerDown(e) {
      if (!ctx) return;
      drawing = true;
      const rect = document.getElementById('annotationCanvas').getBoundingClientRect();
      startX = e.clientX - rect.left;
      startY = e.clientY - rect.top;
      if (tool === 'brush') {
        ctx.beginPath();
        ctx.moveTo(startX, startY);
      }
    }

    function pointerMove(e) {
      if (!drawing || !ctx) return;
      const rect = document.getElementById('annotationCanvas').getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      if (tool === 'brush') {
        ctx.strokeStyle = document.getElementById('colorPicker').value;
        ctx.lineWidth = document.getElementById('brushSize').value;
        ctx.lineTo(x, y);
        ctx.stroke();
        // commit stroke
        origImageData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);
      } else {
        // preview shapes
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.putImageData(origImageData, 0, 0);
        ctx.strokeStyle = document.getElementById('colorPicker').value;
        ctx.lineWidth = document.getElementById('brushSize').value;
        if (tool === 'rect') {
          ctx.strokeRect(startX, startY, x - startX, y - startY);
        } else if (tool === 'ellipse') {
          const rx = Math.abs(x - startX) / 2;
          const ry = Math.abs(y - startY) / 2;
          const cx = (startX + x) / 2;
          const cy = (startY + y) / 2;
          ctx.beginPath();
          ctx.ellipse(cx, cy, rx, ry, 0, 0, 2 * Math.PI);
          ctx.stroke();
        }
      }
    }

    function pointerUp(e) {
      if (!drawing || !ctx) return;
      drawing = false;
      // commit final shape
      origImageData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);
    }

    function clearAnnotations() {
      if (!ctx || !initialImageData) return;
      ctx.putImageData(initialImageData, 0, 0);
      origImageData = initialImageData;
    }

    function saveItem(evt) {
      evt.preventDefault();
      alert('é …ç›®å·²ä¿å­˜');
    }
  </script>

  <script>
  const LIFF_ID = '2007306147-DrM2yLeA';
  const GAS_API = 'https://script.google.com/macros/s/AKfycbz1RUvNGAlQjAFTx7gdNKcqb189bZfTuTklGRL8EimQ5SsjIwhViMtQOqpR6_5EVkI/exec';

  window.onload = async function () {
    document.getElementById('homePage').classList.add('d-none');
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }

      const profile = await liff.getProfile();
      const userId = profile.userId;

      const res = await fetch(GAS_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId })
      });

      const result = await res.json();
      if (result.status === 'authorized') {
        document.getElementById('userWelcome').innerText = `ğŸ‘‹ æ­¡è¿ ${profile.displayName}`;
        document.getElementById('homePage').classList.remove('d-none');
      } else {
        alert("âŒ ä½ ä¸åœ¨ç™½åå–®ä¸­ï¼Œç„¡æ³•ä½¿ç”¨æœ¬ç³»çµ±");
        liff.logout();
        window.location.href = 'login.html';
      }
    } catch (err) {
      alert("ç™»å…¥å¤±æ•—æˆ–åˆå§‹åŒ–éŒ¯èª¤ï¼š" + err.message);
    }
  }
</script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
